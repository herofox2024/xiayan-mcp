"""Markdown formatter with theme support."""

import re
from typing import Dict, Optional
import frontmatter
import markdown
from bs4 import BeautifulSoup
from jinja2 import Environment, BaseLoader

from ..themes.theme_manager import ThemeManager


class MarkdownFormatter:
    """Format markdown content with themes for WeChat publishing."""

    def __init__(self):
        """Initialize the formatter."""
        self.theme_manager = ThemeManager()
        self.md = markdown.Markdown(extensions=[
            'markdown.extensions.extra',
            'markdown.extensions.codehilite',
            'markdown.extensions.toc',
            'markdown.extensions.tables',
            'markdown.extensions.fenced_code',
        ])

    def format(self, content: str, theme_id: str = "default") -> Dict[str, str]:
        """
        Format markdown content with specified theme.
        
        Args:
            content: Raw markdown content with optional frontmatter
            theme_id: Theme identifier to apply
            
        Returns:
            Dictionary containing title, cover, and formatted HTML content
        """
        # Parse frontmatter
        post = frontmatter.loads(content)
        metadata = post.metadata
        markdown_content = post.content
        
        # Extract title and cover from frontmatter
        title = metadata.get('title', '')
        cover = metadata.get('cover', '')
        
        # Convert markdown to HTML
        html_content = self.md.convert(markdown_content)
        
        # Apply theme styling
        theme = self.theme_manager.get_theme(theme_id)
        styled_html = self._apply_theme(html_content, theme)
        
        return {
            "title": title,
            "cover": cover,
            "content": styled_html
        }

    def _apply_theme(self, html_content: str, theme: 'Theme') -> str:
        """
        Apply theme styling to HTML content.
        
        Args:
            html_content: Raw HTML content
            theme: Theme to apply
            
        Returns:
            Styled HTML content
        """
        # Parse HTML
        soup = BeautifulSoup(html_content, 'html.parser')
        
        # Apply theme-specific styling
        if theme.css_styles:
            style_tag = soup.new_tag('style')
            style_tag.string = theme.css_styles
            soup.insert_before(style_tag)
        
        # Wrap in theme template
        template_env = Environment(loader=BaseLoader())
        template = template_env.from_string(theme.template)
        
        return template.render(
            content=str(soup),
            css_styles=theme.css_styles or ""
        )

    def _extract_images(self, html_content: str) -> list:
        """Extract all image URLs from HTML content."""
        soup = BeautifulSoup(html_content, 'html.parser')
        images = []
        
        for img in soup.find_all('img'):
            src = img.get('src', '')
            if src:
                images.append(src)
        
        return images

    def _auto_generate_cover(self, html_content: str) -> Optional[str]:
        """Automatically select first image as cover if none provided."""
        images = self._extract_images(html_content)
        return images[0] if images else None